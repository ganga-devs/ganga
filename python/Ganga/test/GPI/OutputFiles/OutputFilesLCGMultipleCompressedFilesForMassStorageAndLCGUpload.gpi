from GangaTest.Framework.utils import sleep_until_state
import os

dictConfig = config.Output.MassStorageFile
dictConfig['uploadOptions']['path'] = dictConfig['uploadOptions']['path'].replace('$user', '%s/%s' % (os.environ['USER'][0], os.environ['USER']))

config.Output.MassStorageFile = dictConfig

j = Job(application=Root(),backend=LCG())

j.application.script = File('fillrandom.py')

j.outputfiles = ['*.root', '*.root1']

j.outputfiles[0].compressed = True
j.outputfiles[1].compressed = True

assert(j.outputfiles[0].__class__.__name__ == 'MassStorageFile')
assert(j.outputfiles[1].__class__.__name__ == 'LCGStorageElementFile')

j.submit()

sleep_until_state(j, timeout=3600, state='completed')

assert(j.outputfiles[0].location() != [])
assert(j.outputfiles[1].location() != [])

j.outputfiles[0].localDir = j.outputdir
j.outputfiles[1].localDir = j.outputdir

j.outputfiles[0].get()
j.outputfiles[1].get()

for filename in ['fillrandom.root.gz', 'fillrandom1.root.gz', j.outputfiles[1].location()[0][-10:], j.outputfiles[1].location()[1][-10:]]:
    assert(filename in os.listdir(j.outputdir)) 
    
