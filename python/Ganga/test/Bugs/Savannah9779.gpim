# make sure that the job is correctly commited at submit time
# this test program should be run twice

import os,new,types
from GangaTest.Framework.tests import MultipassTest

class Savannah9779(MultipassTest):

    def __init__(self):
        MultipassTest.__init__(self,3)
        self.name = '/tmp/ganga.commit_test2_data.123'

    def pass1(self):
        print 'PASS 1: create new job'
        jobs.remove()
        j = Job()
        j.application = Executable()
        j.backend = Local()
        print 'created job',j.id
        print j
        file(self.name,'w').write(str(-j.id))
        print 'saved job id %s to file %s'%(j.id,self.name)

    def pass2(self):
        try:
            jobid = int(file(self.name).read())
        except IOError:
            print 'failed to open file:',self.name
        except ValueError:
            print 'failed to read file:',self.name

        print 'PASS 2: modify the job'
        j = jobs(-jobid)
        file(self.name,'w').write(str(j.id))
        j.backend = Batch()
        j.application.exe = 'myexecutable'
        print j
        self.check_job(j)

    def pass3(self):
        try:
            jobid = int(file(self.name).read())
        except IOError:
            print 'failed to open file:',self.name
        except ValueError:
            print 'failed to read file:',self.name

        print 'PASS 3: checkout job and compare'
        os.remove(self.name)
        j = jobs(jobid)
        print j
        self.check_job(j)
        print 'test passed OK'

    def check_job(self,j):
        assert(typename(j.application) == 'Executable')
        assert(j.application.exe == 'myexecutable')
        assert(typename(j.backend) == config.Configuration.Batch)

