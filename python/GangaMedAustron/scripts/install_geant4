# GangaMedAustron - Dietrich Liko, August 2009
#
# Submit an installation job
#

import os

import GangaMedAustron

def getFile(name):

    return File(os.path.abspath(os.path.join(os.path.dirname(GangaMedAustron.__file__),name)))

def install_job(ce_list):

    job = Job()
    job.inputsandbox = [ getFile('share/install_geant4.sh'),
                         getFile('share/MD5SUM'),
                         getFile('share/patch1'),
                         getFile('share/patch2') ]
    job.application = Executable()
    job.application.exe =  getFile('share/gridinstall_geant4.sh')
    job.application.args = ''
    job.backend = LCG()
    job.splitter = GenericSplitter()
    job.splitter.attribute = 'backend.CE'
    job.splitter.values = ce_list

    return job

def ce_list():

    import re
    from Ganga.Utility.GridShell import getShell

    gshell = getShell()
    rc, output, m = gshell.cmd1("lcg-infosites --vo voce ce")
    return re.findall('(\S+)\n',output)[2:]

if __name__ == '__main__':

    from optparse import OptionParser

    parser = OptionParser(usage = 'usage: %prog [options] ce ...',
                          description='Submit jobs to install GEANT4 for MedAustron on VOCE sites')

    parser.add_option('-a','--all',
                      dest='all',default=False,action='store_true',
                      help='Install on all CEs')

    options, args = parser.parse_args()

    if options.all:
        ce_list = ce_list()
    else:
       if args:
          ce_list = args
       else:
          ce_list = ['hephygr.oeaw.ac.at:2119/jobmanager-lcgpbs-voce']

    job = install_job(ce_list)
    job.submit()
