import os, tempfile, sys
from GangaTest.Framework.utils import sleep_until_completed, write_file, file_contains
from os.path import join,basename,exists
import time

# Job with a script
scriptname=tempfile.mktemp()
code = """#!/bin/env python
f=open('output.txt','w')
f.write('This is a test %f \\n')
f.close()
""" % time.time()
write_file(scriptname,code)
print 'code =', code
jscript=Job(application=Executable(),backend=Dirac())
jscript.backend.settings['CPUTime'] = 300
jscript.application.exe=File(scriptname)
jscript.application.args=[]
jscript.outputdata = ['output.txt']
jscript.submit()
sleep_until_completed(jscript)

print 'j = ', jscript

tmpdir = tempfile.mktemp()
os.mkdir(tmpdir)

output = jscript.backend.getOutputData(dir=tmpdir)

assert len(output) == 1, 'Only one file should have been downloaded - %s' % output

outfile = os.path.join(tmpdir,'output.txt')
assert os.path.exists(outfile), 'File should exist'

#clean up
os.unlink(outfile)
try:
    os.rmdir(tmpdir)
except OSError,e:
    print e
    print 'Directory content',os.listdir(tmpdir)
