from GangaTest.Framework.utils import sleep_until_completed, write_file, file_contains
from os import mkdir, chmod
from os.path import join,basename,exists
import tempfile

# Job with a script
scriptname=tempfile.mktemp('.py')
write_file(scriptname,"""#!/bin/env python
from random import choice
import string
f=open('output.txt','w')
f.write('This is a test\\n')
chars = string.letters + string.digits
kbyte=1024
text=''.join([choice(chars) for i in range(kbyte)])
f.write(text)
f.close()
""")
os.chmod(scriptname,0700)
jscript=Job(name='OutputData',application=Executable(),backend=Dirac(CPUTime=300))
jscript.application.exe=File(scriptname)
jscript.application.args=[]
jscript.outputdata=['output.txt']
jscript.submit()

sleep_until_completed(jscript)
assert jscript.status == 'completed', 'job must complete'

downloadedFiles = jscript.backend.getOutputData()
# TODO: This seems to be broken
#assert 'output.txt' in downloadedFiles, 'output.txt must be downloaded - %s' \
#    % str(downloadedFiles)

output_file = join(jscript.outputdir,'output.txt')
assert exists(output_file), 'File must exist'

assert(file_contains(output_file,'This is a test'))
lfns = jscript.backend.getOutputDataLFNs()
assert len(lfns) == 1, 'We only expect one LFN'
assert basename(lfns[0]) == 'output.txt', 'Check the LFN is as expected'